# 收集nginx日志
input {
    file {
        codec => "plain"
        discover_interval => 15
        # exclude => ... # array (optional)
        path => ["/home/datatist/workspace/nginx/logs/access_message_server.log" ]
        sincedb_path => "/home/datatist/workspace/logstash/sincedb/sincedb-access_message_server"
        sincedb_write_interval => 1
        start_position => "beginning"
        stat_interval => 1
        # tags => ... # array (optional)
        type => nginx_log
    }
}
filter {
    if [type] =~ "nginx_log" {
        grok {
            match => {
                "message" => "%{COMBINEDAPACHELOG} \"%{GREEDYDATA:request_body}\""
                # "path" => "/home/%{USERNAME:host_user}/.*/access\.(%{GREEDYDATA:service_name}\.|)log"
            }
            break_on_match => false
        }
        grok {
            match => {
                "request" => "/(datatist\.php|c\.gif)\??%{GREEDYDATA:request_args}"
            }
            break_on_match => false
        }
        date {
            match => [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
        }
	# mutate {
        #     gsub => [ 'request_body', '\\x22', '"']
        # }
        mutate {
            remove_field => "message"
            remove_field => "request"
        }
    }
}

output {
     stdout { codec => rubydebug }
     kafka {
         	# codec => avro {
         	# 	schema_uri => "/home/datatist/workspace/logstash/conf/message.avsc"
            #}
        codec => json_lines
        bootstrap_servers => "slave01:9092,slave02:9092,slave03:9092"
        topic_id => "event-ff"
     }
}

